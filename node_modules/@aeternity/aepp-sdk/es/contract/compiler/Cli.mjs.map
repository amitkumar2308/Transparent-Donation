{"version":3,"file":"Cli.mjs","names":["_child_process","execFile","_os","tmpdir","_path","resolve","dirname","basename","_fsPromises","mkdir","writeFile","rm","_url","fileURLToPath","CompilerBase","CompilerError","InternalError","UnsupportedVersionError","semverSatisfies","ensureError","getPackagePath","path","import","meta","url","_path2","WeakMap","_ensureCompatibleVersion","_run","WeakSet","CompilerCli","constructor","compilerPath","arguments","length","undefined","ignoreVersion","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","writable","value","Promise","_classPrivateFieldSet","version","then","versions","compile","_classPrivateFieldGet","bytecode","aci","all","_classPrivateMethodGet","_run2","call","res","JSON","parse","trimEnd","error","message","compileBySourceCode","sourceCode","fileSystem","tmp","_classStaticPrivateMethodGet","_saveContractToTmpDir","recursive","generateAci","generateAciBySourceCode","validate","includes","validateBySourceCode","_verMessage$match","verMessage","ver","match","_len","parameters","Array","_key","pResolve","pReject","stdout","stderr","randomName","Math","random","toString","slice","sourceCodePath","Object","entries","map","_ref","name","src","p"],"sources":["../../../src/contract/compiler/Cli.ts"],"sourcesContent":["import { execFile } from 'child_process';\nimport { tmpdir } from 'os';\nimport { resolve, dirname, basename } from 'path';\nimport { mkdir, writeFile, rm } from 'fs/promises';\nimport { fileURLToPath } from 'url';\nimport CompilerBase, { Aci } from './Base';\nimport { Encoded } from '../../utils/encoder';\nimport { CompilerError, InternalError, UnsupportedVersionError } from '../../utils/errors';\nimport semverSatisfies from '../../utils/semver-satisfies';\nimport { ensureError } from '../../utils/other';\n\nconst getPackagePath = (): string => {\n  const path = dirname(fileURLToPath(import.meta.url));\n  if (basename(path) === 'dist') return resolve(path, '..');\n  if (basename(path) === 'compiler') return resolve(path, '../../..');\n  throw new InternalError('Can\\'t get package path');\n};\n\n/**\n * A wrapper around aesophia_cli, available only in Node.js.\n * Requires Erlang installed, assumes that `escript` is available in PATH.\n */\nexport default class CompilerCli extends CompilerBase {\n  #path: string;\n\n  #ensureCompatibleVersion = Promise.resolve();\n\n  /**\n   * @param compilerPath - A path to aesophia_cli binary, by default uses the integrated one\n   * @param options - Options\n   * @param options.ignoreVersion - Don't ensure that the compiler is supported\n   */\n  constructor(\n    compilerPath = resolve(getPackagePath(), './bin/aesophia_cli'),\n    { ignoreVersion }: { ignoreVersion?: boolean } = {},\n  ) {\n    super();\n    this.#path = compilerPath;\n    if (ignoreVersion !== true) {\n      this.#ensureCompatibleVersion = this.version().then((version) => {\n        const versions = [version, '7.2.1', '8.0.0'] as const;\n        if (!semverSatisfies(...versions)) throw new UnsupportedVersionError('compiler', ...versions);\n      });\n    }\n  }\n\n  async #run(...parameters: string[]): Promise<string> {\n    return new Promise((pResolve, pReject) => {\n      execFile('escript', [this.#path, ...parameters], (error, stdout, stderr) => {\n        if (error != null) pReject(error);\n        else if (stderr !== '') pReject(new CompilerError(stderr));\n        else pResolve(stdout);\n      });\n    });\n  }\n\n  static async #saveContractToTmpDir(\n    sourceCode: string,\n    fileSystem: Record<string, string> = {},\n  ): Promise<string> {\n    const randomName = (): string => Math.random().toString(36).slice(2);\n    const path = resolve(tmpdir(), `aepp-sdk-js-${randomName()}`);\n    await mkdir(path);\n    const sourceCodePath = resolve(path, `${randomName()}.aes`);\n    await writeFile(sourceCodePath, sourceCode);\n    await Promise.all(Object.entries(fileSystem)\n      .map(async ([name, src]) => {\n        const p = resolve(path, name);\n        await mkdir(dirname(p), { recursive: true });\n        return writeFile(p, src);\n      }));\n    return sourceCodePath;\n  }\n\n  async compile(path: string): Promise<{\n    bytecode: Encoded.ContractBytearray;\n    aci: Aci;\n  }> {\n    await this.#ensureCompatibleVersion;\n    try {\n      const [bytecode, aci] = await Promise.all([\n        this.#run(path),\n        this.#run('--create_json_aci', path).then((res) => JSON.parse(res)),\n      ]);\n      return {\n        bytecode: bytecode.trimEnd() as Encoded.ContractBytearray,\n        aci,\n      };\n    } catch (error) {\n      ensureError(error);\n      throw new CompilerError(error.message);\n    }\n  }\n\n  async compileBySourceCode(sourceCode: string, fileSystem?: Record<string, string>): Promise<{\n    bytecode: Encoded.ContractBytearray;\n    aci: Aci;\n  }> {\n    const tmp = await CompilerCli.#saveContractToTmpDir(sourceCode, fileSystem);\n    try {\n      return await this.compile(tmp);\n    } finally {\n      await rm(dirname(tmp), { recursive: true });\n    }\n  }\n\n  async generateAci(path: string): Promise<Aci> {\n    await this.#ensureCompatibleVersion;\n    try {\n      return JSON.parse(await this.#run('--no_code', '--create_json_aci', path));\n    } catch (error) {\n      ensureError(error);\n      throw new CompilerError(error.message);\n    }\n  }\n\n  async generateAciBySourceCode(\n    sourceCode: string,\n    fileSystem?: Record<string, string>,\n  ): Promise<Aci> {\n    const tmp = await CompilerCli.#saveContractToTmpDir(sourceCode, fileSystem);\n    try {\n      return await this.generateAci(tmp);\n    } finally {\n      await rm(dirname(tmp), { recursive: true });\n    }\n  }\n\n  async validate(bytecode: Encoded.ContractBytearray, path: string): Promise<boolean> {\n    await this.#ensureCompatibleVersion;\n    try {\n      return (await this.#run(path, '--validate', bytecode)).includes('Validation successful.');\n    } catch (error) {\n      return false;\n    }\n  }\n\n  async validateBySourceCode(\n    bytecode: Encoded.ContractBytearray,\n    sourceCode: string,\n    fileSystem?: Record<string, string>,\n  ): Promise<boolean> {\n    const tmp = await CompilerCli.#saveContractToTmpDir(sourceCode, fileSystem);\n    try {\n      return await this.validate(bytecode, tmp);\n    } finally {\n      await rm(dirname(tmp), { recursive: true });\n    }\n  }\n\n  async version(): Promise<string> {\n    const verMessage = await this.#run('--version');\n    const ver = verMessage.match(/Sophia compiler version ([\\d.]+)\\n/)?.[1];\n    if (ver == null) throw new CompilerError('Can\\'t get compiler version');\n    return ver;\n  }\n}\n"],"mappings":"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"}