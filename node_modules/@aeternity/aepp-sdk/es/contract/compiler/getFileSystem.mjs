import _flagsInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/flags";
import _fsPromises from 'fs/promises';
const {
  readFile
} = _fsPromises;
import _path from 'path';
const {
  dirname,
  resolve,
  basename
} = _path;
import { InternalError } from "../../utils/errors.mjs";
const defaultIncludes = ['List.aes', 'Option.aes', 'String.aes', 'Func.aes', 'Pair.aes', 'Triple.aes', 'BLS12_381.aes', 'Frac.aes', 'Set.aes', 'Bitwise.aes'];
const includeRegExp = /^include\s*"([\w/.-]+)"/mi;
const includesRegExp = new RegExp(includeRegExp.source, `${_flagsInstanceProperty(includeRegExp)}g`);
async function getFileSystemRec(root, relative) {
  var _sourceCode$match;
  const sourceCode = await readFile(resolve(root, relative), 'utf8');
  const filesystem = {};
  await Promise.all(((_sourceCode$match = sourceCode.match(includesRegExp)) !== null && _sourceCode$match !== void 0 ? _sourceCode$match : []).map(include => {
    const m = include.match(includeRegExp);
    if ((m === null || m === void 0 ? void 0 : m.length) !== 2) throw new InternalError('Unexpected match length');
    return m[1];
  }).filter(include => !defaultIncludes.includes(include)).map(async include => {
    const includePath = resolve(root, include);
    filesystem[include] = await readFile(includePath, 'utf8');
    Object.assign(filesystem, await getFileSystemRec(root, include));
  }));
  return filesystem;
}

/**
 * Reads all files included in the provided contract
 * Available only in Node.js
 * @param path - a path to the main contract source code
 */
export default async function getFileSystem(path) {
  return getFileSystemRec(dirname(path), basename(path));
}
//# sourceMappingURL=getFileSystem.mjs.map